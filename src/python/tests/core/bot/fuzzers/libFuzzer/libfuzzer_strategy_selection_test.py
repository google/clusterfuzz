# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
"""Tests for strategy selection file."""

import unittest

from bot.fuzzers import strategy
from bot.fuzzers.libFuzzer import strategy_selection
<<<<<<< HEAD
from datastore import data_types
from datastore import ndb
from tests.test_libs import helpers as test_helpers
from tests.test_libs import test_utils


class TestRandomStrategySelectionGeneratorPatched(unittest.TestCase):
  """Tests whether program properly generates strategy
  sets for use by the launcher."""

  def setUp(self):
    """Set up method for strategy pool generator tests with patch."""
    test_helpers.patch_environ(self)
    test_helpers.patch(self,
                       ['bot.fuzzers.engine_common.decide_with_probability'])
    self.mock.decide_with_probability.return_value = True

  def test_random_pool_generator(self):
    """Deterministically tests the random strategy pool generator."""
    strategy_pool = strategy_selection.generate_random_strategy_pool()

    # Ml rnn and radamsa strategies are mutually exclusive. Because of how we
    # patch, ml rnn will evaluate to false, however this depends on the
    # implementation.
    self.assertTrue(
        strategy_pool.do_strategy(strategy.CORPUS_MUTATION_RADAMSA_STRATEGY))
    self.assertFalse(
        strategy_pool.do_strategy(strategy.CORPUS_MUTATION_ML_RNN_STRATEGY))
    self.assertTrue(strategy_pool.do_strategy(strategy.CORPUS_SUBSET_STRATEGY))
    self.assertTrue(
        strategy_pool.do_strategy(strategy.RANDOM_MAX_LENGTH_STRATEGY))
    self.assertTrue(
        strategy_pool.do_strategy(strategy.RECOMMENDED_DICTIONARY_STRATEGY))
    self.assertTrue(strategy_pool.do_strategy(strategy.VALUE_PROFILE_STRATEGY))
    self.assertTrue(strategy_pool.do_strategy(strategy.FORK_STRATEGY))
    self.assertTrue(strategy_pool.do_strategy(strategy.MUTATOR_PLUGIN_STRATEGY))


class TestStrategySelectionPatchless(unittest.TestCase):
  """Tests to see whether a strategy pool is properly generated by the file."""

  def test_strategy_pool_generator(self):
    """Ensures that a call to generate_strategy_pool does not yield an
    exception. Deterministic behaviors are tested in the previous test."""
    strategy_selection.generate_random_strategy_pool()


@test_utils.with_cloud_emulators('datastore')
class TestMultiArmedBanditStrategySelectionPatch(unittest.TestCase):
  """Tests whether a multi armed bandit strategy pool is properly
  generated according to the specified distribution."""

  def setUp(self):
    """Put data in the local ndb table the tests to query from."""
    data = []

    strategy1 = data_types.FuzzStrategyProbability()
    strategy1.strategy_name = 'fork,subset,dict,'
    strategy1.probability = 0.33
    data.append(strategy1)

    strategy2 = data_types.FuzzStrategyProbability()
    strategy2.strategy_name = 'max len,ml rnn,value profile,dict,'
    strategy2.probability = .34
    data.append(strategy2)

    strategy3 = data_types.FuzzStrategyProbability()
    strategy3.strategy_name = 'radamsa,max len,subset,'
    strategy3.probability = .33
    data.append(strategy3)
    ndb.put_multi(data)

  def test_multi_armed_bandit_strategy_pool(self):
    """Ensures a call to the multi armed bandit strategy
    selection function doesn't yield an exception."""
    strategy_selection.generate_strategy_pool()


@test_utils.with_cloud_emulators('datastore')
class TestMultiArmedBanditStrategySelection(unittest.TestCase):
  """Tests whether multi armed bandit strategy pool is properly generated
  according to the specified distribution.

  Deterministic tests.Only one strategy is put in the ndb table upon setup,
  so we know what the drawn strategy pool should be."""

  def setUp(self):
    """Put data in the local ndb table the tests to query from."""
    data = []

    strategy2 = data_types.FuzzStrategyProbability()
    strategy2.strategy_name = 'max len,ml rnn,value profile,dict,'
    strategy2.probability = 1
    data.append(strategy2)
    ndb.put_multi(data)

  def test_strategy_pool_deterministic(self):
    """Tests whether a proper strategy pool is returned
    by the multi armed bandit selection implementation.

    Based on deterministic strategy selection."""
    strategy_pool = strategy_selection.generate_strategy_pool()
    self.assertTrue(
        strategy_pool.do_strategy(strategy.CORPUS_MUTATION_ML_RNN_STRATEGY))
    self.assertTrue(
        strategy_pool.do_strategy(strategy.RANDOM_MAX_LENGTH_STRATEGY))
    self.assertTrue(strategy_pool.do_strategy(strategy.VALUE_PROFILE_STRATEGY))
    self.assertTrue(
        strategy_pool.do_strategy(strategy.RECOMMENDED_DICTIONARY_STRATEGY))
    self.assertFalse(
        strategy_pool.do_strategy(strategy.CORPUS_MUTATION_RADAMSA_STRATEGY))
    self.assertFalse(strategy_pool.do_strategy(strategy.CORPUS_SUBSET_STRATEGY))
    self.assertFalse(strategy_pool.do_strategy(strategy.FORK_STRATEGY))
    self.assertFalse(
        strategy_pool.do_strategy(strategy.MUTATOR_PLUGIN_STRATEGY))
